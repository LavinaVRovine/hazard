-- summarizes player-game stats to team-game stats
with stats as (select sum("A") a, sum("D") d, avg("KAST") kast, avg("K/D Diff") kd_diff,
       sum("FK Diff") fk_diff, sum("K") k, sum("HS") hs, game_id, team_id,
                      avg(
           case
               WHEN rating2 notnull  THEN rating2
               WHEN rating1 notnull THEN rating1
               else null
           END )as ratings
from players_stats
GROUP BY game_id, team_id),
     --calculates winrate for team per year
winrate as (
     SELECT ROUND(
             100.0 * (
                 SUM(CASE
                       WHEN winner = true THEN 1
                       ELSE 0 END) :: DECIMAL / COUNT(games.game_id)
                 ), 1) AS win_pct,
      COUNT(games.game_id) games_count,
       extract(year from unix_time) as winrate_year, team_id
from games
JOIN matches on matches.match_id = games.match_id
JOIN games_teams ON games.game_id=games_teams.game_id
GROUP BY winrate_year, team_id
    )

select avg(a) a, avg(d) d, avg(kast) kast, avg(kd_diff) kd_diff,
       avg(fk_diff) fk_diff, avg(k) k, avg(hs) hs, avg(ratings) ratings,
      max(win_pct) max_winrate,

       stats.team_id,  extract(year from unix_time) as year from games_teams
join stats ON stats.game_id=games_teams.game_id AND stats.team_id=games_teams.team_id
JOIN games ON games.game_id = games_teams.game_id
join matches ON games.match_id=matches.match_id
join winrate ON winrate.team_id = stats.team_id AND winrate.winrate_year = extract(year from unix_time)
GROUP BY year, stats.team_id






